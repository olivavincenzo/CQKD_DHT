version: '3.8'

services:
  bootstrap:
    build:
      context: .
      dockerfile: Dockerfile
    image: cqkd-dht-node:latest # Nome immagine più specifico
    container_name: cqkd-bootstrap
    environment:
      - DHT_PORT=5678
      - LOG_LEVEL=INFO
    ports:
      - "5678:5678/udp"
    networks:
      - cqkd-network
    command: ["python", "-m", "scripts.bootstrap_node"]
    restart: on-failure

  worker:
    image: cqkd-dht-node:latest
    # Non definire un container_name per permettere lo scaling
    environment:
      - DHT_PORT=7000 # Porta interna per i worker
      - BOOTSTRAP_NODES=bootstrap:5678
      - LOG_LEVEL=INFO
    depends_on:
      - bootstrap
    networks:
      - cqkd-network
    command: ["python", "-m", "scripts.worker_node"]
    restart: on-failure

  bob:
    image: cqkd-dht-node:latest
    container_name: cqkd-bob
    environment:
      - DHT_PORT=6001
      - BOOTSTRAP_NODES=bootstrap:5678
      - LOG_LEVEL=DEBUG
    depends_on:
      - bootstrap
      - worker # Bob attende che almeno un worker sia avviato
    networks:
      - cqkd-network
    command: ["python", "-m", "scripts.bob_node"]
    restart: no # Non riavviare Bob, è un processo one-shot

  alice:
    image: cqkd-dht-node:latest
    container_name: cqkd-alice
    environment:
      - DHT_PORT=6000
      - BOOTSTRAP_NODES=bootstrap:5678
      - BOB_ADDRESS=bob:6001
      - LOG_LEVEL=DEBUG
    depends_on:
      - bob # Alice attende che Bob sia pronto a ricevere
    networks:
      - cqkd-network
    command: ["python", "-m", "scripts.alice_node"]
    restart: no # Anche Alice è un processo one-shot

networks:
  cqkd-network:
    driver: bridge
