version: '3.8'

services:
  bootstrap:
    build:
      context: .
      dockerfile: Dockerfile
    image: cqkd-dht-node:latest
    container_name: cqkd-bootstrap
    environment:
      - DHT_PORT=5678
    ports:
      - "5678:5678/udp"
    networks:
      - cqkd-network
    command: ["python", "-m", "scripts.bootstrap_node"]
    restart: unless-stopped

  worker:
    image: cqkd-dht-node:latest
    environment:
      - DHT_PORT=7000
      - BOOTSTRAP_NODES=bootstrap:5678
    depends_on:
      - bootstrap
    networks:
      - cqkd-network
    command: ["python", "-m", "scripts.worker_node"]
    restart: unless-stopped

  bob:
    image: cqkd-dht-node:latest
    container_name: cqkd-bob
    environment:
      - DHT_PORT=6001
      - BOOTSTRAP_NODES=bootstrap:5678
    depends_on:
      - bootstrap
    networks:
      - cqkd-network
    ports:
      - "8002:8000" # Mappa la porta interna 8000 di Bob (FastAPI/API) alla 8002 dell'host
      - "6001:6001/udp" # Mappa la porta interna 6001 di Bob (DHT) alla 6001 dell'host
    command: ["python", "-m", "scripts.bob_node"]
    restart: unless-stopped

  alice:
    image: cqkd-dht-node:latest
    container_name: cqkd-alice
    environment:
      - DHT_PORT=6000
      - BOOTSTRAP_NODES=bootstrap:5678
      - BOB_DHT_ADDRESS=bob:6001 # Indirizzo di Bob nella rete DHT
    depends_on:
      - bob # Alice deve assicurarsi che Bob sia avviato per potergli parlare via API
      - worker
    networks:
      - cqkd-network
    ports:
      - "8001:8000" # Mappa la porta interna 8000 di Alice (FastAPI) alla 8001 dell'host
      - "6000:6000/udp" # Mappa la porta interna 6000 di Alice (DHT) alla 6000 dell'host
    command: ["uvicorn", "protocol.alice:app", "--host", "0.0.0.0", "--port", "8000"]
    restart: unless-stopped

networks:
  cqkd-network:
    driver: bridge
