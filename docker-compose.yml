version: '3.8'

services:
  bootstrap-primary:
    build:
      context: .
      dockerfile: Dockerfile
    image: cqkd-dht-node:latest
    container_name: cqkd-bootstrap-primary
    environment:
      - DHT_PORT=5678
      - NODE_ID=bootstrap-primary
    ports:
      - "5678:5678/udp"
    networks:
      - cqkd-network
    command: ["python", "-m", "scripts.bootstrap_node"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]  # Semplice check
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  bootstrap-secondary:
    build:
      context: .
      dockerfile: Dockerfile
    image: cqkd-dht-node:latest
    container_name: cqkd-bootstrap-secondary
    environment:
      - DHT_PORT=5679
      - NODE_ID=bootstrap-secondary
      - BOOTSTRAP_NODES=bootstrap-primary:5678
    ports:
      - "5679:5679/udp"
    networks:
      - cqkd-network
    depends_on:
      bootstrap-primary:
        condition: service_healthy
    command: ["python", "-m", "scripts.bootstrap_node"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  worker:
    image: cqkd-dht-node:latest
    environment:
      - DHT_PORT=7000
      - BOOTSTRAP_NODES=bootstrap-primary:5678,bootstrap-secondary:5679
    depends_on:
      bootstrap-primary:
        condition: service_healthy
      bootstrap-secondary:
        condition: service_healthy
    networks:
      - cqkd-network
    command: ["python", "-m", "scripts.worker_node"]
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  bob:
    image: cqkd-dht-node:latest
    container_name: cqkd-bob
    environment:
      - DHT_PORT=6001
      - BOOTSTRAP_NODES=bootstrap-primary:5678,bootstrap-secondary:5679
    depends_on:
      - bootstrap-primary
      - bootstrap-secondary
    networks:
      - cqkd-network
    ports:
      - "8002:8000" # Mappa la porta interna 8000 di Bob (FastAPI/API) alla 8002 dell'host
      - "6001:6001/udp" # Mappa la porta interna 6001 di Bob (DHT) alla 6001 dell'host
    command: ["python", "-m", "scripts.bob_node"]
    restart: unless-stopped

  alice:
    image: cqkd-dht-node:latest
    container_name: cqkd-alice
    environment:
      - DHT_PORT=6000
      - BOOTSTRAP_NODES=bootstrap-primary:5678,bootstrap-secondary:5679
      - BOB_DHT_ADDRESS=bob:6001 # Indirizzo di Bob nella rete DHT
    depends_on:
      - bob # Alice deve assicurarsi che Bob sia avviato per potergli parlare via API
      - bootstrap-primary
      - bootstrap-secondary
    networks:
      - cqkd-network
    ports:
      - "8001:8000" # Mappa la porta interna 8000 di Alice (FastAPI) alla 8001 dell'host
      - "6000:6000/udp" # Mappa la porta interna 6000 di Alice (DHT) alla 6000 dell'host
    command: ["uvicorn", "protocol.alice:app", "--host", "0.0.0.0", "--port", "8000"]
    restart: unless-stopped

networks:
  cqkd-network:
    driver: bridge
